name: Backend CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: Run Bandit (Security static analysis)
        run: bandit -r . -x ./tests,./venv,./conversational_ai/tests,./clera_agents/tests,./.venv
        continue-on-error: true
        
      - name: Check dependencies for vulnerabilities
        run: safety check -r requirements.txt
        continue-on-error: true
        
      - name: Run Semgrep for security scanning
        run: |
          python -m pip install --upgrade pip
          pip install "semgrep==1.64.0"
          semgrep --config p/owasp-top-ten --sarif -o semgrep-results.sarif
        continue-on-error: ${{ github.event_name == 'pull_request' }}
          
      - name: Upload SARIF file
        if: ${{ hashFiles('backend/semgrep-results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3.25.15
        with:
          sarif_file: backend/semgrep-results.sarif
          category: semgrep
        continue-on-error: true

  lint:
    name: Linting and Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Set up Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black

      - name: Run Flake8
        run: flake8 . --exclude=.venv,venv,__pycache__,tests
        continue-on-error: true
        
      - name: Run Black (check formatting)
        run: black --check --exclude="/(\.venv|venv|__pycache__|tests)/" .
        continue-on-error: true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [security-scan, lint]
    defaults:
      run:
        working-directory: ./backend
    services:
      redis:
        image: redis:6.2.17
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      # Environment variables redacted for security
      # Use GitHub Secrets for sensitive data
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # WebSocket testing environment variables
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      WEBSOCKET_SERVICE_URL: localhost:8001
      WEBSOCKET_TIMEOUT: 300
      WEBSOCKET_CONNECT_TIMEOUT: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7

      - name: Set up Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # In case pytest is not already in requirements.txt
          pip install pytest pytest-cov

      - name: Run pytest
        run: |
          # Check if tests directory exists before running tests
          if [ -d "tests" ] || [ -d "clera_agents/tests" ] || [ -d "conversational_ai/tests" ]; then
            pytest --cov=. --cov-report=xml
          else
            echo "No test directories found. Skipping tests."
            # Create an empty coverage report so the next step doesn't fail
            echo '<?xml version="1.0" ?><coverage version="5.5"></coverage>' > coverage.xml
          fi
        
      - name: Upload coverage report
        uses: codecov/codecov-action@v4.5.0
        with:
          file: ./backend/coverage.xml
          fail_ci_if_error: false

  # ============================================================================
  # DEPLOYMENT NOTE: 
  # Production deployment is handled by AWS CodePipeline (via Copilot).
  # When you push to main, CodePipeline automatically:
  #   1. Builds Docker images in AWS CodeBuild (no local Docker space issues!)
  #   2. Pushes to Amazon ECR
  #   3. Deploys both api-service and websocket-lb-service to ECS
  #
  # To check deployment status:
  #   - AWS Console → CodePipeline → clera-main
  #   - Or run: copilot pipeline status
  #
  # The GitHub Actions workflow below only validates Docker builds on PRs
  # to catch issues before they reach the main branch.
  # ============================================================================

  # Validate Docker builds on PRs (similar to Vercel preview builds)
  # This catches Dockerfile issues before they break production
  validate-docker-build:
    name: Validate Docker Build (PR Only)
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.4.0

      # Build API service image (no push - just validate)
      - name: Build API service image (validation only)
        uses: docker/build-push-action@v6.5.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: clera-backend:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha,scope=api-service-pr
          cache-to: type=gha,mode=max,scope=api-service-pr

      # Build WebSocket service image (no push - just validate)
      - name: Build WebSocket service image (validation only)
        uses: docker/build-push-action@v6.5.0
        with:
          context: ./backend
          file: ./backend/Dockerfile.websocket
          push: false
          tags: clera-backend-websocket:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha,scope=websocket-service-pr
          cache-to: type=gha,mode=max,scope=websocket-service-pr

  # Notify that deployment is handled by AWS CodePipeline
  deployment-info:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment notification
        run: |
          echo "=============================================="
          echo "Tests passed! Deployment triggered."
          echo "=============================================="
          echo ""
          echo "AWS CodePipeline is now building and deploying:"
          echo "  - api-service"
          echo "  - websocket-lb-service"
          echo ""
          echo "Monitor deployment at:"
          echo "  AWS Console -> CodePipeline -> clera-main"
          echo ""
          echo "Or run locally:"
          echo "  copilot pipeline status"
          echo "=============================================="